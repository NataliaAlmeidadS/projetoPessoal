<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/dash.css">
  <title>Dashboard</title>
</head>

<body onload="grafico1(); mostrarKpi() ;votacaoIndividual();">
  <section id="dash">
    <div class="header">
      <div class="containerTit">
        <a href="./index.html">
          <h1 class="titulo">Inner</h1>
          <div>
            <h2 class="titulo2">Guide</h2>
          </div>
        </a>
      </div>
      <div class="container">
        <ul class="navbar">
          <a href="./index.html">
            <li>Home</li>
          </a>
          <a href="./votacao.html">
            <li>Votação</li>
          </a>
          <a href="#dash">
            <li>Dashboard</li>
          </a>
          <div class="divLC">
            Olá, <span id="b_usuario">usuário</span>!
          </div>
        </ul>
      </div>
    </div>
  </section>

  <section id="Dashboard">
    <div class="grafico1">
      <canvas width="30px" height="10px" id="myChart"></canvas>
      <div id="kpi_box">
        <div id="kpi_value"></div>
        <div id="kpi_title">Total de votos de <span id="p_usuario"></span></div>
      </div>
    </div>

    <div class="grafico1">
      <canvas width="30px" height="10px" id="myChart2"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  </section>
</body>
<script>
  // Validação da sessão
  const idUser = sessionStorage.ID_USUARIO;

  function validarSessao() {
    const email = sessionStorage.EMAIL_USUARIO;
    const nome = sessionStorage.NOME_USUARIO;

    if (!email || !nome) {
      alert("Sessão inválida! Faça login novamente.");
      window.location = "./login.html";
    } else {
      document.getElementById("b_usuario").innerHTML = nome;
      document.getElementById("p_usuario").innerHTML = nome;
    }
  }

  validarSessao();
  function grafico1() {
    // Gráfico 1 (barra)
    const ctx = document.getElementById('myChart').getContext('2d');

    fetch('/usuarios/dados-dashboard')
      .then(response => {
        if (!response.ok) throw new Error('Erro ao obter os dados do servidor');
        return response.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) throw new Error("Dados inválidos ou vazios.");

        const determineColor = (label) => {
          return label.startsWith('M')
            ? 'rgba(54, 162, 235, 0.2)'
            : 'rgba(255, 99, 132, 0.2)';
        };

        // Calcular o valor máximo dos dados para ajustar o eixo Y
        const valorMaximo = Math.max(...data.map(item => item['Livro Vencedor']));

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(item => item['Livro Escolhido']),
            datasets: [{
              label: 'Todos os votos',
              data: data.map(item => item['Livro Vencedor']),
              backgroundColor: data.map(item => determineColor(item['Livro Escolhido'])),
              borderColor: data.map(item => determineColor(item['Livro Escolhido']).replace('0.2', '1')),
              borderWidth: 1,
              barThickness: 87 // Ajusta a largura da barra, igual ao gráfico 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: valorMaximo + 10,  // Ajusta o valor máximo do eixo Y
                grid: {
                  color: '#6c6877af',  // Cor das linhas da grade
                },
                border: {
                  color: '#6c6877af',
                }
              },
              x: {
                ticks: {
                  display: false,  // Esconde as marcas no eixo X
                },
                grid: {
                  color: '#6c6877af',  // Cor das linhas da grade
                },
                border: {
                  color: '#6c6877af'
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: '#FFFF'  // Cor da legenda
                }
              },
              tooltip: {
                titleColor: '#FFFF',
                bodyColor: '#FFFF',
              },
              title: {
                display: true,
                text: 'Votação de Livros',
                color: '#FFFF',
                font: {
                  size: 25,
                  weight: 'bold'
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Erro ao obter os dados:', error));
}


  let grafico
  function votacaoIndividual() {
    fetch(`/usuarios/votacaoIndividual/${idUser}`)
        .then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    grafico2(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
}
function grafico2(resposta) {
    // Gráfico 2
    console.log('carregou a 2');
    const ctx5 = document.getElementById('myChart2').getContext('2d');

    let index = 0;

    // Destruir o gráfico anterior, se existir
    if (grafico) {
        grafico.destroy();  // Destrói o gráfico anterior
    }

    if (Array.isArray(resposta)) {
        const dados = resposta.map(item => item.qtdVotos);  // Dados extraídos da resposta
        const labels = ["Livro1", "Livro2", "Livro3", "Livro4"]; // Exemplo de labels

        console.log('Dados extraídos:', dados);

        if (dados.length === 0) {
            console.error('Nenhum dado encontrado para o gráfico.');
            return;
        }

        // Calcular o valor máximo dos dados para ajustar o eixo Y
        const valorMaximo = Math.max(...dados);

        const determineColor = (label) => {
            return label.startsWith('L')
                ? 'rgba(54, 162, 235, 0.2)'  // Cor azul para rótulos que começam com 'M'
                : 'rgba(255, 99, 132, 0.2)'; // Cor vermelha para os outros
        };

        // Criação do gráfico
        grafico = new Chart(ctx5, {
            type: 'bar',
            data: {
                labels: [],  // Inicializa com um array vazio
                datasets: [{
                    label: 'Votos',
                    data: [],  // Inicializa com um array vazio
                    backgroundColor: [],  // Inicializa com um array vazio
                    borderColor: [],  // Inicializa com um array vazio
                    borderWidth: 1,
                    barThickness: 87 // Ajusta a largura da barra
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 0,
                        max: valorMaximo + 10,  // Ajusta o valor máximo do eixo Y
                        grid: {
                            color: '#6c6877af',
                        },
                        border: {
                            color: '#6c6877af',
                        }
                    },
                    x: {
                        ticks: {
                            display: false,  // Esconde as marcas no eixo X
                        },
                        grid: {
                            color: '#6c6877af',
                        },
                        border: {
                            color: '#6c6877af'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                        labels: {
                            color: '#FFFF'
                        }
                    },
                    tooltip: {
                        titleColor: '#FFFF',
                        bodyColor: '#FFFF',
                    },
                    title: {
                        display: true,
                        text: `Votos ${sessionStorage.NOME_USUARIO}`,
                        color: '#FFFF',
                        font: {
                            size: 25,
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // Atualização incremental
        const intervalo = setInterval(() => {
            if (index >= dados.length) {
                clearInterval(intervalo);  // Para a atualização quando todos os dados forem processados
                return;
            }

            // Atualiza os dados do gráfico
            grafico.data.labels.push(labels[index % labels.length]);  // Rótulos cíclicos
            grafico.data.datasets[0].data.push(dados[index]);  // Adiciona os dados
            grafico.data.datasets[0].backgroundColor.push(determineColor(labels[index]));  // Cor de fundo
            grafico.data.datasets[0].borderColor.push(determineColor(labels[index]).replace('0.2', '1'));  // Cor da borda

            // Atualiza o gráfico
            grafico.update();
            index++;
        }, 1000); // Intervalo de 5 segundos para cada atualização
    } else {
        console.error('A resposta da API não é um array.', resposta);
    }
}





  //   console.log('Antes do fetch');
  // fetch(`/usuarios/votacaoIndividual/${idUser}`)
      // .then(response => {
      //   console.log('dps do fetch' + response)
      //   if (!response.ok) throw new Error('Erro ao obter os dados do servidor');
      //   return response.json();
      //   console.log(response.qtdVotos);
        
      // })

      // .then(data => {
      //   console.log(data);

      //   var lista_labels = [];
      //   var lista_data = [];

      //   for (var i = 0; i < data.length; i++) {
      //     lista_labels.push(data[i].nome);
      //     lista_data.push(data[i].qtdVotos)
         
      //   }

      //   new Chart(ctx2, {
      //     type: 'bar',
      //     data: {
      //       labels: lista_labels,
      //       datasets: [{
      //     label: `Votos ${sessionStorage.NOME_USUARIO}`,
      //         data: lista_data,
      //         borderWidth: 1
      //       }]
      //     },
      //     options: {
      //       scales: {
      //         y: {
      //           ticks: { color: 'white' },
      //           beginAtZero: true
      //         },
      //         x: {
      //           ticks: { color: 'white' }
      //         }
      //       },
      //       plugins: {
      //         legend: {
      //           labels: { color: 'white' }
      //         }
      //       }
      //     }
      //   });
      // })
      // .catch(error => console.error('Erro ao obter os dados:', error));
  
  function mostrarKpi() {
    console.log(idUser);
    
    var kpi_value = document.getElementById('kpi_value');

    if (!kpi_value) {
      console.error("Elemento 'kpi_value' não encontrado no DOM.");
    }

    fetch(`/usuarios/kpi?parametro=${idUser}`)
      .then(function (response) {
        if (!response.ok) {
          throw new Error(`Erro na API: Status ${response.status}`);
        }
        return response.text();
      })
      .then(function (resposta) {
        console.log(`Dados recebidos: ${resposta}`);

        const count = parseInt(resposta, 10);

        if (isNaN(count)) {
          throw new Error("A resposta não contém um número válido.");
        }

        console.log(`Valor de count como inteiro: ${count}`);
        if (kpi_value) {
          kpi_value.innerHTML = count;
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados: ${error.message}`);
        if (kpi_value) {
          kpi_value.innerHTML = "Erro ao carregar dados.";
        }
      });

  }
  

</script>

</html>